---
title: "Water Data"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: https://github.com/ucd-cwee/greengov-challenge
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard, quietly = TRUE)
library(rgdal, quietly = TRUE)

# water district boundary
water_dist <- readRDS('data/water_dist.rds')

# water use summary
water_use <- readRDS('data/water_use.rds')

# load and call modules
source('modules/water_district_map.R')

util <- callModule(waterConservation, "water_districts", map_data = water_dist,
                   water_data = water_use, id_field = 'PWSID_1', name_field = 'Supplier_Name')
```

Sidebar {.sidebar}
=======================================================================

### Water Utilities

```{r}
waterConservationInput1('water_districts')
div(style = "margin: 0px 5px", waterConservationInput2('water_districts'))
```


Conservation
=======================================================================

Row
-----------------------------------------------------------------------

### Water Savings {.value-box}

```{r}
# water savings
renderValueBox({
  util_data <- util() %>% 
      filter(selected) %>% 
      summarise(proportionChangeGoal = mean(proportionChangeGoal),
                gal_2013 = sum(TotMonthlyH20Prod2013),
                gal_cur = sum(TotMonthlyH20ProdCurrent)) %>% 
      mutate(prop_change = (gal_2013 - gal_cur) / gal_2013)
    sprintf('%.1f%% (goal: %.f%%)', util_data$prop_change * 100, util_data$proportionChangeGoal * 100)
})
```

### Missed Conservation Standard by {.value-box}

```{r}
# Missed Conservation Standard by
renderValueBox({
  util_data <- util() %>% 
      filter(selected) %>% 
      summarise(proportionChangeGoal = mean(proportionChangeGoal),
                gal_2013 = sum(TotMonthlyH20Prod2013),
                gal_cur = sum(TotMonthlyH20ProdCurrent)) %>% 
      mutate(prop_change = (gal_2013 - gal_cur) / gal_2013,
             sav_diff = proportionChangeGoal - prop_change)
    sprintf('%.1f%%', util_data$sav_diff * 100)
})
```

### GHG Emissions {.value-box}

```{r}
# GHG emissions
renderValueBox({
  water_saved <- util() %>%
    filter(selected) %>%
    mutate(mg_change = (TotMonthlyH20Prod2013 - TotMonthlyH20ProdCurrent) / 1e6,
           ton_co2_saved = mg_change * ghg_factor)
  paste(format(round(sum(water_saved$ton_co2_saved, na.rm = TRUE)), big.mark=",", scientific=FALSE), 'tons CO2e')
})
```

Row
-----------------------------------------------------------------------

### {.nopadding}

```{r}
waterConservationOutput1('water_districts')
```

### {.nopadding}

```{r}
waterConservationOutput2('water_districts')
```


Water Quality
=======================================================================

### Water Quality

